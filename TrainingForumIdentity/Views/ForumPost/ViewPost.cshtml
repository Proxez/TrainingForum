@using Entities
@using Enums
@model PostCommentViewModel

@{
    ViewData["Title"] = Model.Post.Title;
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isOwner = currentUserId != null && currentUserId == Model.Post.UserId.ToString();
}

<h1 class="mb-2">@Model.Post.Title</h1>
<p class="text-muted mb-3">
    @("Av " + (Model.Post.User?.UserName ?? "okänd") + " • " + Model.Post.CreatedAt.ToLocalTime().ToString("g"))
    @if (Model.Post.SubCategory is not null)
    {
        <text> • Underkategori: @Model.Post.SubCategory.Title</text>
    }
</p>

@if (!string.IsNullOrEmpty(Model.Post.ImageUrl))
{
    <img src="@Model.Post.ImageUrl" alt="Post image" class="img-fluid mb-3" />
}

<div class="mb-4">
    <p>@Model.Post.Content</p>
</div>
@if (User?.Identity?.IsAuthenticated == true)
{
    <a class="btn btn-sm btn-outline-danger"
       asp-controller="Report"
       asp-action="CreateReport"
       asp-route-targetType="@ReactionTarget.Post"
       asp-route-targetId="@Model.Post.Id">
        🚩 Rapportera
    </a>
}


@if (isOwner)
{
    <a asp-controller="ForumPost" asp-action="UpdatePost" asp-route-id="@Model.Post.Id" class="btn btn-sm btn-outline-secondary">Redigera</a>
    <form asp-controller="ForumPost" asp-action="DeletePost" asp-route-id="@Model.Post.Id" method="post" style="display:inline;">
        <a>
            <button type="submit" class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Vill du verkligen ta bort detta inlägg?')">
                Delete
            </button>
        </a>

    </form>
}

<hr />
<h4>Kommentarer</h4>

@if (TempData["Error"] is string err)
{
    <div class="alert alert-danger">@err</div>
}
@if (TempData["Success"] is string ok)
{
    <div class="alert alert-success">@ok</div>
}

@if (Model.Comments?.Any() == true)
{
    @foreach (var c in Model.Comments.OrderByDescending(x => x.CreatedAt))
    {
        <div class="border rounded p-2 mb-2">
            <div class="small text-muted mb-1">
                @((c.User?.UserName ?? "okänd") + " • " + c.CreatedAt.ToLocalTime().ToString("g"))
            </div>
            <div>@c.Content</div>
            <a class="btn btn-xs btn-outline-danger"
               asp-controller="Report"
               asp-action="CreateReport"
               asp-route-targetType="@ReactionTarget.Comment">
                🚩 Rapportera
            </a>
        </div>
    }
}
else
{
    <div class="text-muted">Inga kommentarer ännu.</div>
}

@if (User?.Identity?.IsAuthenticated == true)
{
    <h5 class="mt-4">Skriv en kommentar</h5>
    <form asp-controller="ForumPost" asp-action="AddComment" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="postId" value="@Model.Post.Id" />
        <div class="mb-2">
            <textarea name="content" rows="3" class="form-control" placeholder="Din kommentar..." required maxlength="4000"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Publicera</button>
    </form>
}
else
{
    <div class="alert alert-info mt-3">
        <a asp-area="Identity" asp-page="/Account/Login">Logga in</a> för att kommentera.
    </div>
}